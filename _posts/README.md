# 定位任务

### 1. 定位仪器简介

| 仪器名称                                | 数量 | 备注                                                         |
| --------------------------------------- | ---- | ------------------------------------------------------------ |
| [光纤陀螺仪VG910](./2021-03-28-VG.md)   | 2    | 在TR和DR上，使用最频繁                                       |
| [光纤陀螺仪VG103PT](./2021-03-28-VG.md) | 1    | 在川宝小车上，灵敏度高，适用于抖动较小场景                   |
| [yesense](./2021-03-28-yesense.md)      | 3    | 定位组箱子里两个，还有一个在狗上面                           |
| [码盘](./2021-03-28-Encoder.md)         | 3    | 稀缺，催机械组做，目前TRDR和川宝车上各一个                   |
| [导轨+滑块](./2021-03-28-Slider.md)     | 1    | 导轨生锈了，催机械组买滑块，买完后上导轨试一试。滑块的滚珠也放在箱子里。 |
| 陀螺仪标定架                            | 1    | 柜子放不下，找个地方收起来，别弄丢了                         |
| 导轮和夹子、透明工具盒                  |      | 透明盒子里是装车辅助工具，如树脂板、滑块原装顶、尼龙套等。导轮用于对位，夹子用于固定车和滑块。 |

### 2. 定位原理简介

​		全场定位的目标是实时得到小车世界坐标，使小车可运动到预期位姿。具体表现为：**①**直线运动能跑准（保证可运动到预期距离，且不发生偏移），这一部分由参数CM1，CM2，β（Angle2），Ψ（码盘误差角）控制；**②**曲线运动能运动到预期位置且姿态角变化正确，在直线运动准确的基础上，这一部分还受参数α（Angle1），L，陀螺仪积分系数SCALE影响。故定位组需要标定**CM1，CM2（含正反轮径系数），β，Ψ，α，L，SCALE**共9个参数，以达到定位精度。

定位组一般有两个任务：1. 标定陀螺仪；2. 反算模型的参数

* SCALE标定：参考[陀螺仪标定](./2定位原理/陀螺仪标定流程.md)

* 反算小车参数
  
  * 各参数含义:参考[小车基本模型](./2定位原理/代码模型.pdf)
  
  * CM1，CM2，β，Ψ标定:[直线反算](./2定位原理/直线解算及模型反算.pdf)、[联合标定原理](./2定位原理/联合标定原理.pdf)
  * α，L标定：[圆弧反算](./2定位原理/圆弧解算及模型反算.pdf)

### 3. 实验详解及经验

​	在做实验之前需要熟练掌握代码的变量意义以及流程，可以把函数运行时间都统计一下，比如开机采集零点的地方就需要测试一下。我们一般让陀螺仪开机静止5s，用于采集零点。

* [实验流程](./2021-09-09-Process.md)

  

# 定位总结和心得

​		作为一个在定位组待了一年的老人，在这里给大家分享一下我的学习历程以及心得体会，希望能帮助后面的学弟学妹们更快更好地理解定位。

​		在定位组里实验是非常重要的环节。除了刚进定位组的时候需要学习传感器基础以及一些原理知识，后面基本都是在调车-发现问题-找解决方案、改进、总结这样的循环中度过的。

​		刚进定位组要先学传感器基础，比如光纤陀螺仪的参数、编码器的原理，学完之后就看代码，了解整个程序是如何工作。这一段时间的学习笔记和日志都是比较重要的，队里很多大佬喜欢用思维导图或者写个文档记录下每天学习的内容以及安排的任务，一天下来看着自己学会的知识点还是很有成就感的。这一段时间需要学习ucos、定位原理、光纤陀螺仪参数及构造、编码器、滤波方法、惯性导航、通信方式（spi，usart等）和通信协议。

​	学完之后可以进行适当的实践，看一看码盘和光纤陀螺仪。当时刘鑫龙学长给了我一个小导轨和一个码盘，让我测试一下轮径系数。我最开始采用的是非常原始的办法，用米尺量一段距离，找两个东西限位，然后把码盘来回地推，记下脉冲数。然后调了一下yesense，用上位机观测了一下数据。

​		这些都调完之后，就是根据之前的学长总结，解决他们遗留的问题。当时的问题有三个：1. 猜想光纤陀螺仪的输出和转速有关系，但没办法验证；2. 代码中圆弧更新的公式推导失传了；3.定位精度不达标，误差是厘米级别。于是接下来都是针对这些提出想法，设计实验验证。这里需要强调一点，实际模型和理想模型总是有差别的，我们不能仅仅根据理论优化设计实验，还需要考虑实验效果，结合实验数据及理论模型，把误差降到最小。比如轮径系数，理论上码盘的正反轮径系数应该是相等的，但根据之前的测试，两个轮径系数实际上并不相等，而且没有明显的关系，所以就有了正反轮径系数，确定了小车模型一共有多少个参数，最后才有了联合标定。

​		我们很快就在全向轮上做了一些实验，验证了我们的猜想，将定位精度提高了。文件夹里pdf和word里都是那时候写的总结，大家有兴趣可以看一看。

​		原本理论更新部分到这就差不多结束了，但后来随着标车次数增多，我们意识到，想快速、准确地获得参数，我们的实验流程还有很多的优化空间。我们定的目标是不算安装时间，一个小时之内标完车，但由于实验标准不明、偶然性因素多，我们通常要花两倍的时间。现在就给大家分享以下我积累的一些经验。

​		首先，必须明确实验目的。明确实验目的，能保证你更快地获得实验结果。有时候数据不好，可能做一天也没结果，这时候就要结合实验目的想想自己收获了什么。比如说之前我试过一个提高圆弧更新精度的方法，就是用各种优化函数去处理我获得的数据，最后试了一晚上也没达到效果。但我这一晚上并不是没有收获的，起码我知道我试过的这些方法都不能使精度提高。然后再接着想，也许这个数据本来就无法通过优化函数获得最优解呢？于是结合原理，发现事实果然如此。

​		其次，必须制定一个科学的实验标准。做实验一定要问自己三个问题，实验目的，实验流程和实验结论。实验标准是验结果的保障。比如，在直线解算部分，我们规定在推小车时，沿同一方向走同一段距离的码盘的脉冲数上下波动不能超过20，否则就要再做一组实验。数据表明，当我们严格按照实验标准时，我们就可以保证最后小车定位的精度。另外，实验标准也是实验指导。还是直线解算部分举例，我们规定要四组有效的实验数据，而有效数据又是由实验标准决定的，如果没有这个标准，我们可能会白费力气多做了许多组或者少用了几组数据而达不到实验效果。规定实验标准能够帮我们省很多时间和烦恼。

​		科学性指蕴含在实验标准后的数理基础。上文提到的4次，实际上就是用了统计规律。只有当数据大于等于4组时，我们才能分析数据的高斯误差模型。

​		最后，做实验需要不断迭代和优化。我们通过实验发现问题，这些问题反过来又指导我们改进和优化实验。比如陀螺仪标定。没有专业标定陀螺仪的云台，我们自制的设备很难准确地标定陀螺仪，因为陀螺仪转动时会带着电源线和jlink一起，从而缠线，影响测量结果。所以我们用胶枪+匝带把无线jlink+小电池固定在标定架上，并且陀螺仪转动之前都朝同一个方向拧一下，从而尽可能消除转台间隙，降低线对陀螺仪施加的力，减少缠线的次数。

现在定位组想解决的问题主要有下面几个：

		1. 圆弧更新的实验方法。我们现在提出要让实验员将角度精度控制在0.01°以内，这是非常难的事情，所以我们必须改进实验办法，降低对实验员的要求，才能快速获取圆弧更新数据。或者如果经济条件允许，可以购买更专业的设备来辅助标定；
		2. yesense的加速度滤波

3. 如果还有兴趣，大家可以看一看激光定位。全场定位的概念已经提出10年了，现在更多学校使用激光传感器甚至是视觉定位，大家可以多关注相关内容，跟进新技术。不断的技术更新和迭代才是robocon的初心和魅力所在。

​		